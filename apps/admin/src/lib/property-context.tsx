"use client";

import React, { createContext, useContext, useState, useCallback, useEffect } from "react";

// Types for multitenancy
export interface Property {
  id: string;
  name: string;
  address: string;
  totalRooms: number;
  occupiedRooms: number;
  status: "active" | "inactive" | "maintenance";
}

interface PropertyContextType {
  currentProperty: Property | null;
  properties: Property[];
  setCurrentProperty: (property: Property) => void;
  isLoading: boolean;
}

const PropertyContext = createContext<PropertyContextType | undefined>(undefined);

// Mock data for demonstration - replace with API calls
const mockProperties: Property[] = [
  {
    id: "prop-1",
    name: "Sunrise Boarding House",
    address: "123 Main Street, Downtown",
    totalRooms: 20,
    occupiedRooms: 15,
    status: "active",
  },
  {
    id: "prop-2",
    name: "Oceanview Residence",
    address: "456 Beach Road, Seaside",
    totalRooms: 30,
    occupiedRooms: 28,
    status: "active",
  },
  {
    id: "prop-3",
    name: "Mountain Lodge",
    address: "789 Highland Ave, Uptown",
    totalRooms: 15,
    occupiedRooms: 10,
    status: "maintenance",
  },
];

function getInitialProperty(): Property | null {
  if (typeof window === "undefined") return null;
  const savedPropertyId = localStorage.getItem("bhms-current-property");
  if (savedPropertyId) {
    const savedProperty = mockProperties.find((p) => p.id === savedPropertyId);
    return savedProperty || mockProperties[0];
  }
  return mockProperties[0];
}

export function PropertyProvider({ children }: { children: React.ReactNode }) {
  const [properties] = useState<Property[]>(mockProperties);
  const [currentProperty, setCurrentPropertyState] = useState<Property | null>(null);
  const [isLoading, setIsLoading] = useState(true);

  useEffect(() => {
    // Load saved property from localStorage on mount
    const initialProperty = getInitialProperty();
    if (initialProperty) {
      setCurrentPropertyState(initialProperty);
    }
    setIsLoading(false);
  }, []);

  const setCurrentProperty = useCallback((property: Property) => {
    setCurrentPropertyState(property);
    localStorage.setItem("bhms-current-property", property.id);
  }, []);

  return (
    <PropertyContext.Provider
      value={{
        currentProperty,
        properties,
        setCurrentProperty,
        isLoading,
      }}
    >
      {children}
    </PropertyContext.Provider>
  );
}

export function useProperty() {
  const context = useContext(PropertyContext);
  if (context === undefined) {
    throw new Error("useProperty must be used within a PropertyProvider");
  }
  return context;
}
